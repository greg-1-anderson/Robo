<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://robo.li/collections/">
        <link rel="shortcut icon" href="../../img/favicon.png">
        
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>

	<title>Collections - Robo</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="..//css/robo.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Robo</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Introduction</a>
                    </li>
                
                
                
                    <li >
                        <a href="../getting-started/">Getting Started</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Collections</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tasks <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../tasks/ApiGen/">ApiGen Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Archive/">Archive Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Assets/">Assets Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Base/">Base Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Bower/">Bower Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Composer/">Composer Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Development/">Development Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Docker/">Docker Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/File/">File Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Filesystem/">Filesystem Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Gulp/">Gulp Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Npm/">NPM Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Remote/">SSH, Rsync Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Testing/">Testing Tasks</a>
</li>

                        
                            
<li >
    <a href="../tasks/Vcs/">VCS Tasks</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../changelog/">Releases</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../getting-started/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../tasks/ApiGen/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/consolidation-org/Robo/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        
        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#collection-builders">Collection Builders</a></li>
        
            <li><a href="#collections-api">Collections API</a></li>
        
            <li><a href="#using-a-collection-builder">Using a Collection Builder</a></li>
        
            <li><a href="#rollbacks-and-completions">Rollbacks and Completions</a></li>
        
            <li><a href="#temporary-objects">Temporary Objects</a></li>
        
            <li><a href="#named-tasks">Named Tasks</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="collection-builders">Collection Builders</h1>
<p>Robo provides task collections as a means of making error detection and recovery easier. When Robo tasks are added to a collection, their execution is deferred until the <code>$collection-&gt;run()</code> method is called.  If one of the tasks fail, then the operation will be aborted; rollback tasks may also be defined to restore the system to its original condition.</p>
<p>When using collections, a Robo script will go through three phases:</p>
<ol>
<li>Determine which tasks will need to be run, and create a task builder.</li>
<li>Assign values to variables.</li>
<li>Do not alter the state of the system.</li>
<li>Create the necessary tasks via the task builder.</li>
<li>Use variables calculated in the first phase in task parameters.</li>
<li>Run the tasks via the <code>run()</code> method.</li>
<li>Check and report errors once after <code>run()</code> returns.</li>
</ol>
<p>Following this pattern will keep your code linear and easy to understand.</p>
<h2 id="collections-api">Collections API</h2>
<p>Collections are made up of a combination of tasks and/or <code>callable</code> functions / method pointers, such as:</p>
<ul>
<li>A task (implements TaskInterface)</li>
<li>A function name (string)</li>
<li>A closure (inline function)</li>
<li>A method reference (array with object and method name)</li>
</ul>
<p>Examples of adding different kinds of tasks to a collection are provided below.</p>
<h3 id="taskinterface-objects">TaskInterface Objects</h3>
<pre><code class="php">&lt;?php
  $collection-&gt;add(
    $this-&gt;taskExec('ls')
  );
?&gt;
</code></pre>

<h3 id="functions">Functions</h3>
<pre><code class="php">&lt;?php
  $collection-&gt;addCode('mytaskfunction');
?&gt;
</code></pre>

<h3 id="closures">Closures</h3>
<pre><code class="php">&lt;?php
  $collection-&gt;addCode(
    function() use ($work)
    {
      // do something with $work      
    });
?&gt;
</code></pre>

<h3 id="methods">Methods</h3>
<pre><code class="php">&lt;?php
  $collection-&gt;addCode([$myobject, 'mymethod']);
?&gt;
</code></pre>

<h2 id="using-a-collection-builder">Using a Collection Builder</h2>
<p>To manage a collection of tasks, a collection builder. Collection builders allow tasks to be created via chained methods.  All of the tasks created by the same builder are added to a collection; when the <code>run()</code> method is called, all of the tasks in the collection run. </p>
<p>The 'publish' command from Robo's own RoboFile is shown below.  It uses a collection builder to run some git and filesystem operations. The "completion" tasks are run after all other tasks complete, or during rollback processing when an operation fails.</p>
<pre><code class="php">&lt;?php
class RoboFile extends \Robo\Tasks
{
    public function publish()
    {
        $current_branch = exec('git rev-parse --abbrev-ref HEAD');

        $collection = $this-&gt;collectionBuilder();
        $collection-&gt;taskGitStack()
            -&gt;checkout('site')
            -&gt;merge('master')
        -&gt;completion($this-&gt;taskGitStack()-&gt;checkout($current_branch))
        -&gt;taskFilesystemStack()
            -&gt;copy('CHANGELOG.md', 'docs/changelog.md')
        -&gt;completion($this-&gt;taskFilesystemStack()-&gt;remove('docs/changelog.md'))
        -&gt;taskExec('mkdocs gh-deploy');

        return $collection;
    }
}
?&gt;
</code></pre>

<p>The example above also adds a couple of tasks as "completions"; these are run when the collection completes execution, as explained below.</p>
<h2 id="rollbacks-and-completions">Rollbacks and Completions</h2>
<p>Robo also provides rollbacks and completions, special tasks that are eligible to run only if all of the tasks added to the collection before them succeed. The section below explains the circumstances under which these tasks will run.</p>
<h3 id="completion-tasks">Completion Tasks</h3>
<p>Completions run whenever their collection completes or fails, but only if all of the tasks that come before it succeed. An example of this is shown in the first example above. A filesystem stack task copies CHANDELOG.md to docs/changelog.md; after this task is added to the collection, another filesystem stack task is added as a completion to delete docs/changelog.md. This is done because docs/changelog.md is only intended to exist long enough to be used by the <code>mkdocs</code> task, which is added later. </p>
<h3 id="rollback-tasks">Rollback Tasks</h3>
<p>In addition to completions, Robo also supports rollbacks. Rollback tasks can be used to clean up after failures, so the state of the system does not change when execution is interrupted by an error. A rollback task is executed if all of the tasks that come before it succeed, and at least one of the tasks that come after it fails.  If all tasks succeed, then no rollback tasks are executed.</p>
<h3 id="rollback-and-completion-methods">Rollback and Completion Methods</h3>
<p>Any task may also implement \Robo\Contract\RollbackInterface; if this is done, then its <code>rollback()</code> method will be called if the task is <code>run()</code> on a collection that later fails.</p>
<p>Use <code>addAsCompletion($collection)</code> in place of <code>addAsRollback($collection)</code>, or implement \Robo\Contract\CompletionInterface. Completions otherwise work exactly like rollbacks.</p>
<h2 id="temporary-objects">Temporary Objects</h2>
<p>Since the concept of temporary objects that are cleaned up  on failure is a common pattern, Robo provides built-in support for them. Temporary directories and files are provided out of the box; other kinds of temporary objects can be easily created using the Temporary global collection.</p>
<h3 id="temporary-directories">Temporary Directories</h3>
<p>It is recommended that operations that perform multiple filesystem operations should, whenever possible, do most of their work in a temporary directory. Temporary directories are created by <code>$this-&gt;taskTmpDir()</code>, and are automatically be removed when the collection completes or rolls back. As an added convenience, the CollectionBuilder class has a <code>tmpDir()</code> method that creates a temporary directory via <code>taskTmpDir()</code>, and then returns the path to the temporary directory.</p>
<pre><code class="php">&lt;?php
class RoboFile extends \Robo\Tasks
{
    function myOperation()
    {
        $collection = $this-&gt;collectionBuilder();

        // Create a temporary directory, and fetch its path.
        $work = $collection-&gt;tmpDir();

        $collection
          -&gt;taskWriteToFile(&quot;$work/README.md&quot;)
            -&gt;line('-----')
            -&gt;line(date('Y-m-d').' Generated file: do not edit.')
            -&gt;line('----');

        // If all of the preceding tasks succeed, then rename the temporary 
        // directory to its final name.
        $collection-&gt;taskFilesystemStack()
          -&gt;rename($work, 'destination');

        return $collection-&gt;run();
    }
}
?&gt;
</code></pre>

<p>In the previous example, the path to the temporary directory is stored in the variable <code>$work</code>, and is passed as needed to the parameters of the other tasks as they are added to the collection. After the task collection is run, the temporary directory will be automatically deleted. In the example above, the temporary directory is renamed by the last task in the collection. This allows the working directory to persist; the collection will still attempt to remove the working directory, but no errors will be thrown if it no longer exists in its original location. Following this pattern allows Robo scripts to easily and safely do work that cleans up after itself on failure, without introducing a lot of branching or additional error recovery code.  This paradigm is common enough to warrant a shortcut method of accomplishing the same thing.  The example below is identical to the one above, save for the fact that it uses the <code>workDir()</code> method instead of <code>tmpDir()</code>.  <code>workDir()</code> renames the temporary directory to its final name if the collection completes; any directory that exists in the same location will be overwritten at that time, but will persist if the collection roles back.</p>
<pre><code class="php">&lt;?php
class RoboFile extends \Robo\Tasks
{
    function myOperation()
    {
        $collection = $this-&gt;collectionBuilder();

        // Create a temporary directory, and fetch its path.
        // If all of the tasks succeed, then rename the temporary directory
        // to its final name.
        $work = $collection-&gt;workDir('destination');

        $collection
          -&gt;taskWriteToFile(&quot;$work/README.md&quot;)
            -&gt;line('-----')
            -&gt;line(date('Y-m-d').' Generated file: do not edit.')
            -&gt;line('----');

        return $collection-&gt;run();
    }
}
?&gt;
</code></pre>

<p>Temporary directories may also be created via the shortcut <code>$this-&gt;_tmpDir();</code>. Temporary directories created in this way are deleted when the script terminates.</p>
<h3 id="temporary-files">Temporary Files</h3>
<p>Robo also provides an API for creating temporary files. They may be created via <code>$this-&gt;taskTmpFile()</code>; they are used exactly like <code>$this-&gt;taskWrite()</code>, except they are given a random name on creation, and are deleted when their collection completes.  If they are not added to a collection, then they are deleted when the script terminates.</p>
<h3 id="the-temporary-global-collection">The Temporary Global Collection</h3>
<p>Robo maintains a special collection called the Temporary global collection. This collection is used to keep track of temporary objects that are not part of any collection. For example, Robo temporary directories and temporary files are managed by the Temporary global collection. These temporary objects are cleaned up automatically when the script terminates.</p>
<p>It is easy to create your own temporary tasks that behave in the same way as the provided temporary directory and temporary file tasks. There are two steps required:</p>
<ul>
<li>Implement \Robo\Contract\CompletionInterface</li>
<li>Wrap the task via Temporary::wrap()</li>
</ul>
<p>For example, the implementation of taskTmpFile() looks like this:</p>
<pre><code class="php">&lt;?php
    protected function taskTmpFile($filename = 'tmp', $extension = '', $baseDir = '', $includeRandomPart = true)
    {
        return Temporary::wrap(new TmpFile($filename, $extension, $baseDir, $includeRandomPart));
    }
?&gt;
</code></pre>

<p>The <code>complete()</code> method of the task will be called once the Collection the temporary object is attached to finishes running. If the temporary is not added to a collection, then its <code>complete()</code> method will be called when the script terminates.</p>
<h2 id="named-tasks">Named Tasks</h2>
<p>It is also possible to provide names for the tasks added to a collection. This has two primary benefits:</p>
<ol>
<li>Any result data returned from a named task is stored in the Result object under the task name.</li>
<li>It is possible for other code to add more tasks before or after any named task.</li>
</ol>
<p>This feature is useful if you have functions that create task collections, and return them as a function results. The original caller can then use the <code>$collection-&gt;before()</code> or <code>$collection-&gt;after()</code> to insert sequenced tasks into the set of operations to be performed. One reason this might be done would be to define a base set of operations to perform (e.g. in a deploy), and then apply modifications for other environments (e.g. dev or stage).</p>
<pre><code class="php">&lt;?php
  $collection-&gt;addCode(
    function() use ($work)
    {
      // do something with $work      
    },
    &quot;taskname&quot;);
?&gt;
</code></pre>

<p>Given a collection with named tasks, it is possible to insert more tasks before or after a task of a given name.</p>
<pre><code class="php">&lt;?php
  $collection-&gt;after(&quot;taskname&quot;,
    function() use ($work)
    {
      // do something with $work after &quot;taskname&quot; executes, if it succeeds.    
    });
?&gt;
</code></pre>

<pre><code class="php">&lt;?php
  $collection-&gt;before(&quot;taskname&quot;,
    function() use ($work)
    {
      // do something with $work before &quot;taskname&quot; executes.    
    });
?&gt;
</code></pre>

<p>It is recommended that named tasks be avoided unless specifically needed.</p></div>
            

        </div>
        

        <footer class="col-md-12">
            <div >

                <p>Robo is product of <a href="http://codegyre.com">Codegyre</a>. 

</p>
<p>
    Robo is on <a href="http://twitter.com/robo_php">Twitter</a> and on <a href="https://github.com/codegyre/robo">GitHub</a>
</p>
                
                <p>
                    See also:
                    <a href="http://codeception.com">Codeception</a> |
                    <a href="https://github.com/Codeception/AspectMock">AspectMock</a> |
                    <a href="http://phptest.club">PHP Test Club</a>
                </p>
            </div>
        </footer>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>